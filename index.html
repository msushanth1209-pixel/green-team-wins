<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Hive - Party Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Bangers&display=swap" rel="stylesheet">
    <style>
        :root { --neon: #39ff14; --pink: #ff00ff; --bg: #111; --card: #222; }
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: #fff; font-family: 'Fredoka', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; overflow: hidden; padding: 20px; text-align: center; }
        
        /* UI ELEMENTS */
        h1 { font-family: 'Bangers'; font-size: 3rem; color: var(--neon); text-shadow: 3px 3px 0 #000; letter-spacing: 2px; }
        .box { background: var(--card); padding: 20px; border-radius: 15px; width: 100%; max-width: 500px; border: 2px solid #333; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        input { background: #fff; border: 3px solid var(--pink); border-radius: 50px; padding: 15px; width: 80%; font-size: 1.2rem; text-align: center; margin: 10px 0; font-weight: bold; outline: none; }
        .btn { background: var(--pink); color: #fff; border: none; padding: 15px 30px; border-radius: 50px; font-family: 'Bangers'; font-size: 1.5rem; cursor: pointer; margin: 10px; width: 80%; transition: transform 0.1s; }
        .btn:active { transform: scale(0.95); }
        .btn-green { background: var(--neon); color: #000; }
        
        .code-display { font-size: 4rem; font-family: 'Bangers'; color: var(--pink); letter-spacing: 10px; margin: 20px 0; border: 4px dashed #444; padding: 10px; background: #1a1a1a; }
        .player-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
        .chip { background: #333; padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; }
        
        /* GAMEPLAY */
        .timer-bar { height: 10px; background: #333; width: 100%; border-radius: 5px; overflow: hidden; margin-bottom: 20px; }
        .timer-fill { height: 100%; background: var(--neon); width: 100%; transition: width 1s linear; }
        .option-btn { background: #fff; color: #000; padding: 15px; margin: 10px 0; border-radius: 15px; font-weight: bold; font-size: 1.2rem; cursor: pointer; border: 4px solid transparent; }
        .option-btn.selected { background: var(--neon); border-color: #fff; transform: scale(1.02); }
        
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .screen.active { display: flex; }

        .big-text { font-size: 2rem; margin-bottom: 20px; line-height: 1.2; font-weight: bold; }
        .wait-text { color: #888; margin-top: 20px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div id="s-home" class="screen active">
        <h1>NEON HIVE</h1>
        <div class="box">
            <button class="btn btn-green" onclick="createGame()">HOST GAME</button>
            <hr style="border:0; border-top:1px solid #444; margin: 20px 0;">
            <input type="text" id="join-code" placeholder="ROOM CODE" maxlength="4" style="text-transform:uppercase;">
            <input type="text" id="join-name" placeholder="YOUR NAME" maxlength="10">
            <button class="btn" onclick="joinGame()">JOIN GAME</button>
        </div>
    </div>

    <div id="s-host-lobby" class="screen">
        <h2>JOIN CODE:</h2>
        <div class="code-display" id="lobby-code">ABCD</div>
        <p>Waiting for players...</p>
        <div id="host-player-list" class="player-list"></div>
        <button class="btn btn-green" onclick="hostStartGame()" style="margin-top:30px;">START GAME</button>
    </div>

    <div id="s-player-wait" class="screen">
        <h1>YOU'RE IN!</h1>
        <p class="wait-text">Watch the host screen...</p>
    </div>

    <div id="s-game" class="screen">
        <div class="timer-bar"><div id="timer" class="timer-fill"></div></div>
        <div id="question-text" class="big-text"></div>
        <div id="options-area" style="width:100%; max-width:500px;"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- ðŸ”´ STEP 1: PASTE YOUR FIREBASE CONFIG HERE ðŸ”´ ---
        const firebaseConfig = {
            apiKey: "AIzaSyAGI4eCHZzDAIpp-jcFmfQN-kSU-yWGFNk",
            authDomain: "green-team-wins.firebaseapp.com",
            databaseURL: "https://green-team-wins-default-rtdb.firebaseio.com",
            projectId: "green-team-wins",
            storageBucket: "green-team-wins.firebasestorage.app",
            messagingSenderId: "409829635726",
            appId: "1:409829635726:web:bd9cd52af347170f40fbdf",
            measurementId: "G-5XFWD6S8J1"
        };
        // -----------------------------------------------------

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let myName = "";
        let roomCode = "";
        let isHost = false;
        let questions = [
            { t: "Best Pizza Topping?", o: ["Pineapple", "Pepperoni", "Mushrooms"] },
            { t: "Worst place to sleep?", o: ["Park Bench", "Office Chair", "Bathtub"] },
            { t: "Scariest Animal?", o: ["Snake", "Spider", "Shark"] },
            { t: "Best Superpower?", o: ["Flight", "Invisibility", "Strength"] },
            { t: "Most annoying sound?", o: ["Chewing", "Baby Crying", "Alarm Clock"] },
            { t: "Best Social Media?", o: ["TikTok", "Instagram", "Twitter"] },
            { t: "If you found $100?", o: ["Save it", "Spend it", "Donate it"] },
            { t: "Best fast food?", o: ["McDonalds", "KFC", "Burger King"] }
        ];

        // --- GLOBAL FUNCTIONS ---
        window.createGame = async () => {
            roomCode = Math.random().toString(36).substring(2, 6).toUpperCase();
            isHost = true;
            
            // Initialize Room in Database
            await set(ref(db, 'rooms/' + roomCode), {
                state: 'LOBBY',
                questionIndex: -1,
                players: {}
            });

            document.getElementById('lobby-code').innerText = roomCode;
            switchScreen('s-host-lobby');
            
            // Listen for players joining
            onValue(ref(db, 'rooms/' + roomCode + '/players'), (snapshot) => {
                const players = snapshot.val() || {};
                document.getElementById('host-player-list').innerHTML = 
                    Object.keys(players).map(p => `<span class="chip">${p}</span>`).join('');
            });
        };

        window.joinGame = async () => {
            roomCode = document.getElementById('join-code').value.toUpperCase();
            myName = document.getElementById('join-name').value.toUpperCase();
            if(!roomCode || !myName) return alert("Enter Code and Name!");

            // Check if room exists
            const roomSnap = await get(ref(db, 'rooms/' + roomCode));
            if(!roomSnap.exists()) return alert("Room not found!");

            // Add player
            await update(ref(db, 'rooms/' + roomCode + '/players/' + myName), { score: 0, answer: -1 });

            switchScreen('s-player-wait');
            
            // LISTEN TO GAME STATE
            onValue(ref(db, 'rooms/' + roomCode), (snap) => {
                const data = snap.val();
                if(!data) return;

                if(data.state === 'QUESTION') {
                    showQuestion(data.questionIndex);
                } else if(data.state === 'RESULTS') {
                    showResults(data);
                }
            });
        };

        window.hostStartGame = () => {
            nextQuestion(0);
        };

        function nextQuestion(index) {
            if(index >= questions.length) return alert("Game Over!");
            
            // Update DB to show question
            update(ref(db, 'rooms/' + roomCode), {
                state: 'QUESTION',
                questionIndex: index,
                startTime: Date.now() // Sync timer
            });

            // Host Logic: Wait 10s then Calculate Results
            setTimeout(() => calculateResults(index), 10000);
        }

        function showQuestion(index) {
            switchScreen('s-game');
            const q = questions[index];
            document.getElementById('question-text').innerText = q.t;
            
            const area = document.getElementById('options-area');
            area.innerHTML = "";
            
            q.o.forEach((opt, i) => {
                const btn = document.createElement('div');
                btn.className = "option-btn";
                btn.innerText = opt;
                btn.onclick = () => submitAnswer(i, btn);
                area.appendChild(btn);
            });

            // Timer Animation
            const timer = document.getElementById('timer');
            timer.style.transition = "none";
            timer.style.width = "100%";
            setTimeout(() => {
                timer.style.transition = "width 10s linear";
                timer.style.width = "0%";
            }, 100);
        }

        function submitAnswer(index, btn) {
            // Visual highlight
            document.querySelectorAll('.option-btn').forEach(b => b.style.opacity = '0.5');
            btn.style.opacity = '1';
            btn.style.background = 'var(--neon)';
            
            // Send to DB
            update(ref(db, 'rooms/' + roomCode + '/players/' + myName), { answer: index });
        }

        async function calculateResults(qIndex) {
            // 1. Get all votes
            const snap = await get(ref(db, 'rooms/' + roomCode + '/players'));
            const players = snap.val() || {};
            
            // 2. Count Votes
            let votes = [0, 0, 0];
            Object.values(players).forEach(p => {
                if(p.answer !== undefined && p.answer !== -1) votes[p.answer]++;
            });

            // 3. Find Majority
            let maxVotes = Math.max(...votes);
            let winningIndex = votes.indexOf(maxVotes); // Simple tie-break: first option wins

            // 4. Update Scores
            let updates = {};
            let roundWinnerNames = [];
            
            Object.keys(players).forEach(name => {
                const p = players[name];
                if(p.answer === winningIndex) {
                    updates['players/' + name + '/score'] = p.score + 1;
                    roundWinnerNames.push(name);
                }
                updates['players/' + name + '/answer'] = -1; // Reset answer
            });
            
            updates['state'] = 'RESULTS';
            updates['lastWinner'] = questions[qIndex].o[winningIndex];
            updates['roundWinners'] = roundWinnerNames.join(", ");

            await update(ref(db, 'rooms/' + roomCode), updates);

            // Wait 5s then next question
            setTimeout(() => nextQuestion(qIndex + 1), 5000);
        }

        function showResults(data) {
            switchScreen('s-game'); // Keep game screen but change text
            document.getElementById('options-area').innerHTML = ""; // Clear buttons
            
            document.getElementById('question-text').innerHTML = `
                <div style="color:#888; font-size:1rem;">MAJORITY VOTED FOR:</div>
                <div style="color:var(--neon); font-size:3rem; margin:10px 0;">${data.lastWinner}</div>
                <div style="color:#fff; font-size:1.2rem; margin-top:20px;">
                    Points go to:<br> <span style="color:var(--pink)">${data.roundWinners || "Nobody!"}</span>
                </div>
            `;
        }

        function switchScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>